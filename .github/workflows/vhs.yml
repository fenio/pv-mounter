name: vhs

on:
  push:
    branches: [main]
    paths:
      - 'demo/**/*.tape'
      - 'demo/**/*.yaml'
      - 'cmd/**'
      - 'pkg/**'
  pull_request:
    paths:
      - 'demo/**/*.tape'
      - 'demo/**/*.yaml'
      - 'cmd/**'
      - 'pkg/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-gifs:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Setup KubeSolo
        id: kubesolo
        uses: fenio/setup-kubesolo@1a38a78a4988905e43d8aad6476392d6a3120cc6 # v5
        with:
          local-storage-shared-path: '/opt/local-path-provisioner'

      - name: Setup Krew
        uses: fenio/setup-krew@c93fbdbdf704bcf87c6a1002e20fe7a8f3eafc4d # v1
        with:
          plugins: 'pv-mounter'

      - name: Test pv-mounter
        run: |
          kubectl pv-mounter --help

      - name: Install VHS and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd zsh nfs-common sshfs
          wget https://github.com/charmbracelet/vhs/releases/download/v0.10.0/vhs_0.10.0_amd64.deb
          sudo dpkg -i vhs_0.10.0_amd64.deb

      - name: Create demo resources
        run: |
          # Apply demo resources in default namespace
          kubectl apply -f demo/unmounted-pvc.yaml
          kubectl apply -f demo/mounted-pvc.yaml
          kubectl apply -f demo/mounted-pod.yaml

          # Wait for PVCs to be bound
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/unmounted-pvc --timeout=120s || true
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/mounted-pvc --timeout=120s

          # Wait for demo-pod to be ready
          kubectl wait --for=condition=Ready pod/demo-pod --timeout=120s

          kubectl get pvc
          kubectl get pod

          # Create mount point
          mkdir -p foo

      - name: Generate unmounted demo GIF
        run: cd demo && vhs unmounted.tape

      - name: Generate mounted demo GIF
        run: cd demo && vhs mounted.tape

      - name: Make pv-mounter plugin available to root
        run: |
          sudo mkdir -p /root/.kube
          sudo cp "$KUBECONFIG" /root/.kube/config
          sudo cp ~/.krew/bin/kubectl-pv_mounter /usr/local/bin/

      - name: Generate NFS demo GIF
        run: cd demo && vhs nfs.tape

      - name: Upload GIF artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: demo-gifs
          path: '*.gif'
          retention-days: 90

      - name: Commit updated GIFs
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f *.gif
          if git diff --quiet --staged; then
            echo "No changes to commit"
          else
            git commit -m "chore: update demo GIFs [skip ci]"
            git push
          fi

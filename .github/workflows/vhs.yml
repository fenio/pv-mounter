name: vhs

on:
  push:
    branches: [main]
    paths:
      - 'demo/**/*.tape'
      - 'demo/**/*.yaml'
      - 'cmd/**'
      - 'pkg/**'
  pull_request:
    paths:
      - 'demo/**/*.tape'
      - 'demo/**/*.yaml'
      - 'cmd/**'
      - 'pkg/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-gifs:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Setup KubeSolo
        id: kubesolo
        uses: fenio/setup-kubesolo@c1b74d8908188836021c63dcbb11fd3747996853 # v5.0.4
        with:
          local-storage-shared-path: '/opt/local-path-provisioner'

      - name: Setup Krew
        uses: fenio/setup-krew@c93fbdbdf704bcf87c6a1002e20fe7a8f3eafc4d # v1
        with:
          plugins: 'pv-mounter'

      - name: Test pv-mounter
        run: |
          kubectl pv-mounter --help

      - name: Install VHS and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd zsh nfs-common sshfs
          wget https://github.com/charmbracelet/vhs/releases/download/v0.10.0/vhs_0.10.0_amd64.deb
          sudo dpkg -i vhs_0.10.0_amd64.deb

      - name: Create demo resources
        run: |
          # Apply demo resources in default namespace
          kubectl apply -f demo/rwx-pvc.yaml
          kubectl apply -f demo/rwo-pvc.yaml
          kubectl apply -f demo/mounted-pod.yaml

          # Wait for PVCs to be bound
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/rwx-pvc --timeout=120s || true
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/rwo-pvc --timeout=120s

          # Wait for demo pod to be ready
          kubectl wait --for=condition=Ready pod/demo --timeout=120s

          # Populate rwo-pvc with sample data via demo pod
          kubectl exec demo -- sh -c "touch /mnt/test/some-file && mkdir -p /mnt/test/some-directory"

          # Populate rwx-pvc with sample data via temporary pod
          cat <<'POPEOF' | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: populate-pvc
          spec:
            restartPolicy: Never
            containers:
              - name: populate
                image: busybox:stable
                command: ["sh", "-c", "touch /mnt/data/some-file && mkdir -p /mnt/data/some-directory"]
                volumeMounts:
                  - name: data
                    mountPath: /mnt/data
            volumes:
              - name: data
                persistentVolumeClaim:
                  claimName: rwx-pvc
          POPEOF
          kubectl wait --for=jsonpath='{.status.phase}'=Succeeded pod/populate-pvc --timeout=120s
          kubectl delete pod populate-pvc

          kubectl get pvc
          kubectl get pod

          # Create mount point (inside demo/ where tapes run)
          mkdir -p demo/foo

      - name: Generate unmounted demo GIF
        run: cd demo && vhs unmounted.tape

      - name: Generate mounted demo GIF
        run: cd demo && vhs mounted.tape

      - name: Make pv-mounter plugin available to root
        run: |
          sudo mkdir -p /root/.kube
          sudo cp "$KUBECONFIG" /root/.kube/config
          sudo cp ~/.krew/bin/kubectl-pv_mounter /usr/local/bin/

      - name: Generate NFS demo GIF
        run: cd demo && vhs nfs.tape

      - name: Generate NFS mounted demo GIF
        run: cd demo && vhs nfs-mounted.tape

      - name: Upload GIF artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: demo-gifs
          path: '*.gif'
          retention-days: 90

      - name: Commit updated GIFs
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f *.gif
          if git diff --quiet --staged; then
            echo "No changes to commit"
          else
            git commit -m "chore: update demo GIFs [skip ci]"
            git push
          fi

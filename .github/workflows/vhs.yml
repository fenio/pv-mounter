name: vhs

on:
  push:
    branches: [main]
    paths:
      - 'demo/**/*.tape'
      - 'cmd/**'
      - 'pkg/**'
  pull_request:
    paths:
      - 'demo/**/*.tape'
      - 'cmd/**'
      - 'pkg/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-gifs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      # TODO: Switch back to setup-kubesolo once KubeSolo releases local-storage-shared-path support
      # Currently this feature is only in the develop branch, so we build from source
      - name: Build KubeSolo from develop branch
        run: |
          # Clone and build KubeSolo from develop branch
          # This is needed because local-storage-shared-path is only in develop branch
          git clone --depth 1 --branch develop https://github.com/portainer/kubesolo.git /tmp/kubesolo
          cd /tmp/kubesolo
          
          # Install Go if needed
          GO_VERSION=1.23.4
          wget -q https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz
          export PATH=$PATH:/usr/local/go/bin
          
          # Build kubesolo
          go build -o kubesolo .
          sudo mv kubesolo /usr/local/bin/kubesolo
          sudo chmod +x /usr/local/bin/kubesolo
          kubesolo --version || echo "Built from develop branch"

      - name: Setup KubeSolo cluster
        run: |
          # Remove existing container runtimes (required by KubeSolo)
          sudo systemctl stop docker docker.socket containerd podman 2>/dev/null || true
          sudo systemctl disable docker docker.socket containerd podman 2>/dev/null || true
          sudo pkill -9 dockerd 2>/dev/null || true
          sudo pkill -9 containerd 2>/dev/null || true
          
          # Rename binaries
          for bin in docker dockerd containerd containerd-shim containerd-shim-runc-v2 runc podman; do
            if [ -f "/usr/bin/$bin" ]; then
              sudo mv "/usr/bin/$bin" "/usr/bin/${bin}.bak"
            fi
          done
          
          # Remove data directories and sockets
          sudo rm -rf /var/lib/docker /var/lib/containerd
          sudo rm -f /var/run/docker.sock /var/run/containerd/containerd.sock
          
          # Remove docker0 network interface
          sudo ip link set docker0 down 2>/dev/null || true
          sudo ip link delete docker0 2>/dev/null || true
          
          # Flush iptables
          sudo iptables -F && sudo iptables -X
          sudo iptables -t nat -F && sudo iptables -t nat -X
          sudo iptables -t mangle -F && sudo iptables -t mangle -X
          sudo iptables -P INPUT ACCEPT && sudo iptables -P FORWARD ACCEPT && sudo iptables -P OUTPUT ACCEPT
          
          # Create data directory
          sudo mkdir -p /var/lib/kubesolo
          
          # Clean up existing CNI directory
          sudo rm -rf /opt/cni/bin 2>/dev/null || true
          
          # Create systemd service with local-storage-shared-path
          cat << 'EOF' | sudo tee /etc/systemd/system/kubesolo.service > /dev/null
          [Unit]
          Description=KubeSolo - Lightweight Kubernetes
          After=network-online.target
          Wants=network-online.target
          
          [Service]
          Type=notify
          Restart=on-failure
          RestartSec=5s
          ExecStart=/usr/local/bin/kubesolo --path=/var/lib/kubesolo --local-storage-shared-path=/opt/local-path-provisioner
          KillMode=process
          Delegate=yes
          LimitNOFILE=1048576
          LimitNPROC=infinity
          LimitCORE=infinity
          TasksMax=infinity
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Start KubeSolo
          sudo systemctl daemon-reload
          sudo systemctl enable kubesolo
          sudo systemctl start kubesolo
          
          # Wait for kubeconfig
          echo "Waiting for kubeconfig..."
          for i in $(seq 1 30); do
            if sudo test -f /var/lib/kubesolo/pki/admin/admin.kubeconfig; then
              sudo chmod 644 /var/lib/kubesolo/pki/admin/admin.kubeconfig
              echo "KUBECONFIG=/var/lib/kubesolo/pki/admin/admin.kubeconfig" >> "$GITHUB_ENV"
              break
            fi
            sleep 2
          done
          
          # Wait for cluster ready
          export KUBECONFIG=/var/lib/kubesolo/pki/admin/admin.kubeconfig
          echo "Waiting for cluster to be ready..."
          for i in $(seq 1 60); do
            if kubectl get nodes --no-headers 2>/dev/null | grep -q " Ready "; then
              echo "Cluster is ready!"
              kubectl get nodes
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done

      - name: Setup Krew
        uses: fenio/setup-krew@c93fbdbdf704bcf87c6a1002e20fe7a8f3eafc4d # v1
        with:
          plugins: 'pv-mounter'

      - name: Test pv-mounter
        run: |
          kubectl pv-mounter --help

      - name: Install VHS and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd zsh
          wget https://github.com/charmbracelet/vhs/releases/download/v0.10.0/vhs_0.10.0_amd64.deb
          sudo dpkg -i vhs_0.10.0_amd64.deb

      - name: Create test PVCs and pods
        run: |
          # Create namespace
          kubectl create namespace demo
          
          # Apply test resources
          kubectl apply -f test/1-pvc.yaml -n demo
          kubectl apply -f test/2-pvc.yaml -n demo
          
          # Wait for PVCs to be bound
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/pvc-1 -n demo --timeout=120s || true
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/pvc-2 -n demo --timeout=120s || true
          
          kubectl describe pvc pvc-1 -n demo
          kubectl describe pvc pvc-2 -n demo
         
          # Create mount point
          mkdir -p foo
          
      - name: ðŸ§ª Generate the gif with vhs
        run: |
          vhs demo/unmounted.tape

      - name: Upload GIF artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: demo-gifs
          path: '*.gif'
          retention-days: 90

      - name: Commit updated GIFs
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add *.gif
          if git diff --quiet --staged; then
            echo "No changes to commit"
          else
            git commit -m "chore: update demo GIFs [skip ci]"
            git push
          fi

name: vhs

on:
  push:
    branches: [main]
    paths:
      - 'demo/**/*.tape'
      - 'demo/**/*.yaml'
      - 'cmd/**'
      - 'pkg/**'
  pull_request:
    paths:
      - 'demo/**/*.tape'
      - 'demo/**/*.yaml'
      - 'cmd/**'
      - 'pkg/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-gifs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Setup KubeSolo
        id: kubesolo
        uses: fenio/setup-kubesolo@v5
        with:
          local-storage-shared-path: '/opt/local-path-provisioner'

      - name: Setup Krew
        uses: fenio/setup-krew@c93fbdbdf704bcf87c6a1002e20fe7a8f3eafc4d # v1
        with:
          plugins: 'pv-mounter'

      - name: Test pv-mounter
        run: |
          kubectl pv-mounter --help

      - name: Install VHS and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd zsh nfs-common
          wget https://github.com/charmbracelet/vhs/releases/download/v0.10.0/vhs_0.10.0_amd64.deb
          sudo dpkg -i vhs_0.10.0_amd64.deb

      - name: Create demo resources
        run: |
          # Create namespace
          kubectl create namespace demo

          # Apply demo resources
          kubectl apply -f demo/unmounted-pvc.yaml -n demo
          kubectl apply -f demo/mounted-pvc.yaml -n demo
          kubectl apply -f demo/mounted-pod.yaml -n demo

          # Wait for PVCs to be bound
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/unmounted-pvc -n demo --timeout=120s || true
          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/mounted-pvc -n demo --timeout=120s

          # Wait for demo-pod to be ready
          kubectl wait --for=condition=Ready pod/demo-pod -n demo --timeout=120s

          kubectl get pvc -n demo
          kubectl get pod -n demo

          # Create mount point
          mkdir -p foo

      - name: Generate unmounted demo GIF
        run: |
          vhs demo/unmounted.tape

      - name: Generate mounted demo GIF
        run: |
          vhs demo/mounted.tape

      - name: Generate NFS demo GIF
        env:
          KUBECONFIG: ${{ env.KUBECONFIG }}
        run: |
          sudo --preserve-env=KUBECONFIG vhs demo/nfs.tape

      - name: Upload GIF artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: demo-gifs
          path: '*.gif'
          retention-days: 90

      - name: Commit updated GIFs
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add *.gif
          if git diff --quiet --staged; then
            echo "No changes to commit"
          else
            git commit -m "chore: update demo GIFs [skip ci]"
            git push
          fi
